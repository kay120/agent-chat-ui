# Code Review 指南

## 📋 目录

- [Code Review 的目的](#code-review-的目的)
- [Review 流程](#review-流程)
- [Review 检查清单](#review-检查清单)
- [Review 意见分类](#review-意见分类)
- [最佳实践](#最佳实践)
- [常见问题](#常见问题)

## Code Review 的目的

### 为什么要做 Code Review？

1. **提高代码质量**
   - 发现潜在的 Bug
   - 改进代码设计
   - 统一代码风格

2. **知识共享**
   - 团队成员了解代码变更
   - 学习新的技术和方法
   - 传播最佳实践

3. **降低风险**
   - 减少生产环境问题
   - 提前发现安全漏洞
   - 避免技术债务积累

4. **团队协作**
   - 促进团队沟通
   - 建立共同的代码标准
   - 提升团队整体水平

## Review 流程

### 1. 提交者准备

#### 提交前自查

```bash
# 1. 运行测试
npm test

# 2. 代码检查
npm run lint

# 3. 格式化代码
npm run format

# 4. 查看变更
git diff
```

#### 创建 PR

1. 填写完整的 PR 描述
2. 关联相关 Issue
3. 添加必要的截图或演示
4. 指定 Reviewers
5. 标记 Review 重点

### 2. Reviewer 准备

#### 接收 Review 请求

- 及时响应 Review 请求
- 了解变更背景和目的
- 准备充足的时间进行 Review

#### Review 环境

- 拉取代码到本地
- 运行代码验证功能
- 查看测试结果

```bash
# 拉取 PR 分支
git fetch origin pull/123/head:pr-123
git checkout pr-123

# 安装依赖
npm install

# 运行测试
npm test

# 启动应用
npm start
```

### 3. 进行 Review

#### Review 顺序

1. **整体浏览** - 了解变更范围和目的
2. **详细检查** - 逐行检查代码
3. **运行验证** - 本地运行测试
4. **提出意见** - 添加 Review 评论

#### Review 重点

- 功能实现是否正确
- 代码质量是否达标
- 是否有潜在问题
- 是否符合项目规范

### 4. 反馈和修改

#### 提交者响应

- 及时回复 Review 意见
- 解释设计决策
- 修改代码并推送
- 标记已解决的评论

#### Reviewer 确认

- 检查修改是否符合要求
- 确认问题已解决
- 给予 Approve 或继续讨论

### 5. 合并

#### 合并条件

- [ ] 所有必须修改的意见已解决
- [ ] 获得足够的 Approve
- [ ] 所有 CI 测试通过
- [ ] 无冲突

#### 合并操作

```bash
# 使用 GitHub/GitLab 界面合并
# 或使用命令行
git checkout dev
git merge --no-ff feature/new-feature
git push origin dev
```

## Review 检查清单

### 功能性检查

- [ ] **需求实现**
  - [ ] 功能符合需求描述
  - [ ] 边界条件处理正确
  - [ ] 错误处理完善
  - [ ] 用户体验良好

- [ ] **逻辑正确性**
  - [ ] 算法逻辑正确
  - [ ] 条件判断准确
  - [ ] 循环终止条件正确
  - [ ] 无死循环或无限递归

- [ ] **数据处理**
  - [ ] 数据验证充分
  - [ ] 数据转换正确
  - [ ] 空值处理妥当
  - [ ] 类型转换安全

### 代码质量检查

- [ ] **可读性**
  - [ ] 代码结构清晰
  - [ ] 命名规范易懂
  - [ ] 注释充分合理
  - [ ] 格式统一规范

- [ ] **可维护性**
  - [ ] 模块划分合理
  - [ ] 职责单一明确
  - [ ] 耦合度低
  - [ ] 易于扩展

- [ ] **复用性**
  - [ ] 无重复代码
  - [ ] 公共逻辑提取
  - [ ] 组件化合理
  - [ ] 工具函数完善

- [ ] **简洁性**
  - [ ] 代码简洁明了
  - [ ] 无冗余代码
  - [ ] 无过度设计
  - [ ] 逻辑清晰直接

### 性能检查

- [ ] **时间复杂度**
  - [ ] 算法效率合理
  - [ ] 无不必要的循环
  - [ ] 查询优化充分
  - [ ] 缓存使用恰当

- [ ] **空间复杂度**
  - [ ] 内存使用合理
  - [ ] 无内存泄漏
  - [ ] 大数据处理优化
  - [ ] 资源及时释放

- [ ] **数据库性能**
  - [ ] 查询优化
  - [ ] 索引使用正确
  - [ ] N+1 问题避免
  - [ ] 批量操作优化

- [ ] **前端性能**
  - [ ] 减少重渲染
  - [ ] 懒加载实现
  - [ ] 资源压缩
  - [ ] 缓存策略

### 安全检查

- [ ] **输入验证**
  - [ ] 用户输入验证
  - [ ] SQL 注入防护
  - [ ] XSS 攻击防护
  - [ ] CSRF 防护

- [ ] **权限控制**
  - [ ] 认证检查
  - [ ] 授权验证
  - [ ] 敏感操作保护
  - [ ] 数据访问控制

- [ ] **数据安全**
  - [ ] 敏感信息加密
  - [ ] 密码安全存储
  - [ ] 日志脱敏
  - [ ] 数据传输加密

- [ ] **依赖安全**
  - [ ] 无已知漏洞
  - [ ] 版本及时更新
  - [ ] 来源可信
  - [ ] 许可证合规

### 测试检查

- [ ] **测试覆盖**
  - [ ] 单元测试充分
  - [ ] 集成测试完善
  - [ ] 边界条件测试
  - [ ] 异常情况测试

- [ ] **测试质量**
  - [ ] 测试用例清晰
  - [ ] 断言准确
  - [ ] 测试独立
  - [ ] 测试可维护

- [ ] **测试结果**
  - [ ] 所有测试通过
  - [ ] 覆盖率达标
  - [ ] 无测试警告
  - [ ] 性能测试通过

### 文档检查

- [ ] **代码注释**
  - [ ] 复杂逻辑有注释
  - [ ] 公共 API 有文档
  - [ ] 注释准确清晰
  - [ ] 无过时注释

- [ ] **文档更新**
  - [ ] README 更新
  - [ ] API 文档更新
  - [ ] 配置说明更新
  - [ ] CHANGELOG 更新

## Review 意见分类

### 严重程度分类

| 标签 | 说明 | 是否阻塞 | 示例 |
|------|------|---------|------|
| 🔴 必须修改 | 严重问题，必须修复 | ✅ 是 | 安全漏洞、严重 Bug、逻辑错误 |
| 🟡 建议修改 | 可以改进，但不强制 | ❌ 否 | 代码优化、性能改进、可读性提升 |
| 🟢 可选优化 | 锦上添花的优化 | ❌ 否 | 命名优化、注释补充、代码简化 |
| 💡 讨论 | 需要讨论的设计问题 | 视情况 | 架构设计、技术选型、实现方案 |
| ✅ 已确认 | 确认无问题 | ❌ 否 | 代码正确、实现合理 |
| ❓ 疑问 | 不确定的地方 | ❌ 否 | 需要作者解释的代码 |

### 意见模板

#### 🔴 必须修改

```markdown
🔴 **必须修改**: SQL 注入风险

**问题**:
直接拼接用户输入到 SQL 查询中，存在 SQL 注入风险。

**位置**:
```python
query = f"SELECT * FROM users WHERE name = '{user_input}'"
```

**建议**:
使用参数化查询：
```python
query = "SELECT * FROM users WHERE name = ?"
cursor.execute(query, (user_input,))
```

**参考**: [OWASP SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection)
```

#### 🟡 建议修改

```markdown
🟡 **建议修改**: 可以优化性能

**问题**:
在循环中进行数据库查询，可能导致 N+1 问题。

**建议**:
使用批量查询或 JOIN 优化：
```python
# 当前实现
for user_id in user_ids:
    user = db.query(User).filter(User.id == user_id).first()

# 优化后
users = db.query(User).filter(User.id.in_(user_ids)).all()
```
```

#### 🟢 可选优化

```markdown
🟢 **可选优化**: 命名可以更清晰

**建议**:
变量名 `data` 太通用，建议改为更具体的名称：
```python
# 当前
data = fetch_data()

# 建议
user_profiles = fetch_user_profiles()
```
```

#### 💡 讨论

```markdown
💡 **讨论**: 是否需要缓存？

**问题**:
这个接口调用频繁，是否考虑添加缓存？

**建议方案**:
1. Redis 缓存，TTL 5分钟
2. 内存缓存，LRU 策略
3. 不缓存，直接查询

**权衡**:
- 缓存可以提升性能，但增加复杂度
- 数据实时性要求如何？
- 缓存失效策略？

请讨论确定方案。
```

## 最佳实践

### 对于 Reviewer

#### 1. 态度和语气

✅ **好的方式**:
```markdown
建议使用更清晰的变量名，比如 `userProfile` 而不是 `data`，
这样可以提高代码可读性。
```

❌ **不好的方式**:
```markdown
这个变量名太烂了，完全看不懂！
```

#### 2. 具体和建设性

✅ **好的方式**:
```markdown
这里可能存在内存泄漏，建议在组件卸载时清理事件监听器：

```javascript
useEffect(() => {
  const handler = () => { /* ... */ };
  window.addEventListener('resize', handler);
  return () => window.removeEventListener('resize', handler);
}, []);
```
```

❌ **不好的方式**:
```markdown
这里有问题。
```

#### 3. 优先级明确

✅ **好的方式**:
```markdown
🔴 **必须修改**: 这里存在安全漏洞，必须修复。
🟡 **建议修改**: 可以优化性能。
🟢 **可选优化**: 命名可以更清晰。
```

#### 4. 及时响应

- 在 4 小时内开始 Review（紧急情况）
- 在 1 个工作日内完成 Review（常规情况）
- 及时回复作者的问题

#### 5. 关注重点

- 先看整体设计和架构
- 再看具体实现细节
- 最后看代码风格

### 对于提交者

#### 1. 主动说明

在 PR 描述中说明：
- 变更的目的和背景
- 技术实现方案
- 需要重点 Review 的部分
- 已知的限制或问题

#### 2. 及时响应

- 及时回复 Review 意见
- 解释设计决策
- 虚心接受建议
- 快速修改问题

#### 3. 保持沟通

- 不确定的地方主动询问
- 有争议的地方友好讨论
- 感谢 Reviewer 的建议

#### 4. 小步提交

- 每个 PR 只做一件事
- 控制 PR 大小（建议 < 400 行）
- 大功能拆分成多个 PR

## 常见问题

### Q: PR 太大怎么办？

**建议**:
1. 拆分成多个小 PR
2. 先合并基础部分
3. 逐步添加功能

**示例**:
```
PR 1: 添加数据库表结构
PR 2: 实现基础 CRUD 操作
PR 3: 添加业务逻辑
PR 4: 添加 API 接口
```

### Q: Review 意见有分歧怎么办？

**处理方式**:
1. 友好讨论，说明各自理由
2. 寻求第三方意见
3. 参考团队规范和最佳实践
4. 必要时线下讨论
5. 达成共识后执行

### Q: 如何处理紧急修复？

**流程**:
1. 创建 hotfix 分支
2. 快速 Review（至少 1 人）
3. 重点检查安全和功能
4. 快速合并和部署
5. 事后补充完整测试

### Q: Review 时间不够怎么办？

**建议**:
1. 优先 Review 重要和紧急的 PR
2. 分配时间进行 Review
3. 团队轮流 Review
4. 使用自动化工具辅助

## Review 工具

### GitHub/GitLab 功能

- **行内评论**: 在具体代码行添加评论
- **建议变更**: 直接建议代码修改
- **Review 状态**: Approve / Request Changes / Comment
- **Draft PR**: 草稿 PR，不需要 Review

### 自动化工具

- **CI/CD**: 自动运行测试和检查
- **Linter**: 自动检查代码风格
- **SonarQube**: 代码质量分析
- **CodeClimate**: 代码质量和安全检查
- **Snyk**: 依赖安全检查

## 相关文档

- [分支管理规范](./BRANCH_MANAGEMENT.md)
- [Pull Request 模板](../../.github/pull_request_template.md)
- [Commit 规范](./COMMIT_CONVENTION.md)
- [发布流程](./RELEASE_PROCESS.md)

---

**文档版本**: v1.0.0  
**最后更新**: 2025-01-16  
**维护者**: 开发团队

